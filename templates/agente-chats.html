<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chats en Vivo â€” Agente Soporte</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/agente-chats.css') }}">
</head>

<body oncontextmenu="return false;" ondragstart="return false;" onselectstart="return false;">
    <div class="rc-container">

        <!-- ENCABEZADO -->
        <header class="rc-header">
            <a href="/agente" class="rc-back">â€¹</a>
            <h1 class="rc-screen-title">Chats en Espera</h1>
            <div></div>
        </header>

        <!-- LISTA DE CHATS -->
        <section class="chats-list" id="chats-container">
            <div class="no-chats">â³ Cargando chats en vivo...</div>
        </section>

    </div>

    <script>
        const idAgente = parseInt(localStorage.getItem('userId'));

        async function cargarChats() {
            const container = document.getElementById('chats-container');
            container.innerHTML = '<div class="no-chats">â³ Cargando chats en vivo...</div>';

            try {
                const response = await fetch('/api/agente/chats-esperando');

                if (!response.ok) throw new Error('Error al cargar chats');

                const data = await response.json();
                mostrarChats(data.chats);

            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = '<div class="no-chats" style="color:#888;">ğŸ’­ No hay sistema de chats en vivo configurado</div>';
            }
        }

        function mostrarChats(chats) {
            const container = document.getElementById('chats-container');

            if (!chats || chats.length === 0) {
                container.innerHTML = '<div class="no-chats">ğŸ’­ No hay chats en espera</div>';
                return;
            }

            container.innerHTML = chats.map(chat => `
        <div class="chat-card">
          <div class="chat-info">
            <h3>ğŸ’¬ Chat #${chat.id_chat}</h3>
            <div class="chat-meta">
              <span>ğŸ‘¤ ${chat.nombre_usuario}</span>
              <span>ğŸ“… ${new Date(chat.fecha_inicio).toLocaleString()}</span>
              <span class="chat-estado estado-esperando">Esperando</span>
            </div>
          </div>
          <button class="btn-tomar" onclick="tomarChat(${chat.id_chat})">Tomar Chat</button>
        </div>
      `).join('');
        }

        async function tomarChat(idChat) {
            if (!confirm('Â¿Deseas tomar este chat?')) return;

            const formData = new FormData();
            formData.append('id_chat', idChat);
            formData.append('id_agente', idAgente);

            try {
                const response = await fetch('/api/agente/tomar-chat', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    window.location.href = `/agente/chat/${idChat}`;
                } else {
                    alert('Error al tomar el chat');
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error al tomar el chat');
            }
        }

        // Cargar al inicio
        cargarChats();

        // Actualizar cada 10 segundos
        setInterval(cargarChats, 10000);
    </script>
    <script src="{{ url_for('static', filename='js/security.js') }}"></script>
</body>

</html>