<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Realizar AuditorÃ­a</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auditor.css') }}">
    <style>
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
    </style>
</head>

<body>
    <div class="rc-header">
        <a href="/auditor" class="rc-back">â€¹</a>
        <h1 class="rc-screen-title">Nueva AuditorÃ­a ISO 14001</h1>
        <div></div>
    </div>

    <div class="rc-container">
        <form id="formAuditoria">
            <!-- InformaciÃ³n General -->
            <div class="section-title">ğŸ“‹ INFORMACIÃ“N GENERAL</div>
            <div class="question-block">
                <label class="question-text">Fecha de la auditorÃ­a:</label>
                <input type="date" id="fecha" name="fecha" required
                    style="width:100%; padding:10px; background:#2a2a2a; border:1px solid #ab925c; color:#fff; border-radius:5px;">
            </div>

            <!-- Contenedor dinÃ¡mico para las preguntas -->
            <div id="cuestionario"></div>

            <button type="submit" class="btn-generate-pdf">âœ… Terminar AuditorÃ­a</button>
        </form>

        <div id="mensaje" style="margin-top:20px; text-align:center; color:#ab925c;"></div>
    </div>

    <script>
        // FunciÃ³n para crear preguntas
        function crearPregunta(nombre, texto) {
            return `
        <div class="question-block">
          <p class="question-text">${texto}</p>
          <div class="options-container">
            <label class="option-label">
              <input type="radio" name="${nombre}" value="Cumple" required>
              <span>âœ… Cumple</span>
            </label>
            <label class="option-label">
              <input type="radio" name="${nombre}" value="No Cumple">
              <span>âŒ No Cumple</span>
            </label>
            <label class="option-label">
              <input type="radio" name="${nombre}" value="Cumple Parcialmente">
              <span>âš ï¸ Cumple Parcialmente</span>
            </label>
            <label class="option-label">
              <input type="radio" name="${nombre}" value="No Aplica">
              <span>â– No Aplica</span>
            </label>
          </div>
        </div>
      `;
        }

        // Datos de auditorÃ­a ISO 14001
        var datosAuditoria = [
            { type: "titulo", texto: "4. CONTEXTO DE LA ORGANIZACIÃ“N" },
            {
                type: "grid", titulo: "4.1 ComprensiÃ³n de la organizaciÃ³n y su contexto", filas: [
                    "Â¿Se tienen identificadas las cuestiones internas y externas asociadas con las necesidades de la empresa?"
                ]
            },
            {
                type: "grid", titulo: "4.2 ComprensiÃ³n de las necesidades y expectativas de las partes interesadas", filas: [
                    "Â¿Se dispone de la correcta metodologÃ­a para la identificaciÃ³n inicial de las partes interesadas?"
                ]
            },
            {
                type: "grid", titulo: "4.3 DeterminaciÃ³n del alcance del SGA", filas: [
                    "Â¿El alcance del SGA es acorde a las metas y objetivos propuestos?"
                ]
            },
            {
                type: "grid", titulo: "4.4 SGA", filas: [
                    "Â¿El SGA inter-relaciona todos los procesos necesarios?"
                ]
            },

            { type: "titulo", texto: "5. LIDERAZGO" },
            {
                type: "grid", titulo: "5.1 Liderazgo y compromiso", filas: [
                    "Â¿La alta direcciÃ³n estÃ¡ comprometida con el SGA?",
                    "Â¿Los objetivos planteados son acordes a las necesidades?",
                    "Â¿Facilita los recursos necesarios para implementar el SGA?",
                    "Â¿Se dirige y apoya a los trabajadores para lograr mejora continua?"
                ]
            },
            {
                type: "grid", titulo: "5.2 PolÃ­tica Ambiental", filas: [
                    "Â¿La empresa tiene establecida una polÃ­tica ambiental?",
                    "Â¿La polÃ­tica tiene soporte teÃ³rico para los objetivos?",
                    "Â¿La polÃ­tica genera compromisos en los empleados?"
                ]
            },
            {
                type: "grid", titulo: "5.3 Roles, responsabilidades y autoridades", filas: [
                    "Â¿La alta direcciÃ³n ha generado canales efectivos de comunicaciÃ³n?"
                ]
            },

            { type: "titulo", texto: "6. PLANIFICACIÃ“N" },
            {
                type: "grid", titulo: "6.1.1 Requisitos Generales", filas: [
                    "Â¿La empresa ha generado indicadores ambientales?",
                    "Â¿Ha identificado riesgos y oportunidades?",
                    "Â¿Cuenta con documentaciÃ³n organizada por procesos?",
                    "Â¿Tiene identificadas situaciones de incidentes y accidentes?",
                    "Â¿Cuenta con documentaciÃ³n del alcance del SGA?"
                ]
            },
            {
                type: "grid", titulo: "6.1.2 Aspectos Ambientales", filas: [
                    "Â¿Cuenta con metodologÃ­a para identificar aspectos ambientales?",
                    "Â¿Ha implementado acciones preventivas y correctivas?",
                    "Â¿La identificaciÃ³n de aspectos se comunicÃ³ en todos los niveles?",
                    "Â¿La informaciÃ³n documentada permite clasificar impactos?"
                ]
            },
            {
                type: "grid", titulo: "6.1.3 Requisitos legales y otros requisitos", filas: [
                    "Â¿La organizaciÃ³n ha identificado sus obligaciones ambientales?",
                    "Â¿Cuenta con procedimientos para requisitos legales?",
                    "Â¿La informaciÃ³n estÃ¡ ordenada y clasificada?"
                ]
            },
            {
                type: "grid", titulo: "6.1.4 PlanificaciÃ³n de acciones", filas: [
                    "Â¿Cuenta con un plan de acciÃ³n para cumplir metas ambientales?"
                ]
            },

            { type: "titulo", texto: "7. APOYO" },
            {
                type: "grid", titulo: "7.1 Recursos", filas: [
                    "Â¿La empresa facilita los recursos suficientes?"
                ]
            },
            {
                type: "grid", titulo: "7.2 Competencia", filas: [
                    "Â¿Cuenta con personal competente?",
                    "Â¿Existe informaciÃ³n documentada de competencias?",
                    "Â¿Se evalÃºa la eficacia de las competencias?"
                ]
            },
            {
                type: "grid", titulo: "7.3 Toma de conciencia", filas: [
                    "Â¿Todo el personal conoce polÃ­tica, objetivos y su rol?",
                    "Â¿Se identifican necesidades de formaciÃ³n?",
                    "Â¿Existen procedimientos para generar conciencia ambiental?"
                ]
            },
            {
                type: "grid", titulo: "7.4.1 ComunicaciÃ³n general", filas: [
                    "Â¿Los procesos de comunicaciÃ³n son efectivos?"
                ]
            },
            {
                type: "grid", titulo: "7.4.2 ComunicaciÃ³n interna", filas: [
                    "Â¿Hay recepciÃ³n, documentaciÃ³n y respuesta de comunicaciones externas?"
                ]
            },
            {
                type: "grid", titulo: "7.4.3 ComunicaciÃ³n externa", filas: [
                    "Â¿Existen procedimientos de comunicaciÃ³n interna?"
                ]
            },
            {
                type: "grid", titulo: "7.5 InformaciÃ³n Documentada", filas: [
                    "Â¿Se describen los elementos del SGA y su interacciÃ³n?",
                    "Â¿Se describe el alcance del SGA?",
                    "Â¿Los documentos estÃ¡n aprobados y revisados segÃºn la norma?"
                ]
            },
            {
                type: "grid", titulo: "7.5.2 CreaciÃ³n y actualizaciÃ³n de documentos", filas: [
                    "Â¿Se cuenta con documentos de control requeridos?"
                ]
            },
            {
                type: "grid", titulo: "7.5.3 Control de informaciÃ³n documentada", filas: [
                    "Â¿La informaciÃ³n estÃ¡ disponible, protegida y almacenada adecuadamente?"
                ]
            },

            { type: "titulo", texto: "8. OPERACIÃ“N" },
            {
                type: "grid", titulo: "8.1 PlanificaciÃ³n y control operacional", filas: [
                    "Â¿Hay control de requisitos ambientales del ciclo de vida?",
                    "Â¿Existen procedimientos para controlar impactos ambientales?"
                ]
            },
            {
                type: "grid", titulo: "8.2 PreparaciÃ³n y respuesta a emergencias", filas: [
                    "Â¿Se identifican situaciones potenciales de emergencia?",
                    "Â¿Se revisan y modifican procedimientos?",
                    "Â¿Se realizan pruebas periÃ³dicas?",
                    "Â¿Existe evidencia documentada?"
                ]
            },

            { type: "titulo", texto: "9. EVALUACIÃ“N DEL DESEMPEÃ‘O" },
            {
                type: "grid", titulo: "9. MediciÃ³n del desempeÃ±o", filas: [
                    "Â¿Existen procedimientos para medir impactos ambientales?"
                ]
            },
            {
                type: "grid", titulo: "9.1.1 General", filas: [
                    "Â¿EstÃ¡ identificado lo que se monitorea?",
                    "Â¿Hay registros de calibraciÃ³n?",
                    "Â¿Hay informaciÃ³n documentada sobre mediciones?"
                ]
            },
            {
                type: "grid", titulo: "9.1.2 EvaluaciÃ³n de cumplimiento", filas: [
                    "Â¿Se evalÃºa cumplimiento legal periÃ³dicamente?",
                    "Â¿Hay registros de evaluaciones?",
                    "Â¿La evaluaciÃ³n ayuda a tomar decisiones ambientales?"
                ]
            },
            {
                type: "grid", titulo: "9.2.2 AuditorÃ­a interna", filas: [
                    "Â¿Se realizan auditorÃ­as internas periÃ³dicas?",
                    "Â¿Hay programa de auditorÃ­as basado en importancia ambiental?"
                ]
            },
            {
                type: "grid", titulo: "9.3 RevisiÃ³n por la direcciÃ³n", filas: [
                    "Â¿La revisiÃ³n del SGA estÃ¡ planificada?",
                    "Â¿La evaluaciÃ³n de auditorÃ­as es Ãºtil para la mejora continua?",
                    "Â¿Existe evidencia documentada?"
                ]
            },

            { type: "titulo", texto: "10. MEJORA" },
            {
                type: "grid", titulo: "10. Mejora", filas: [
                    "Â¿Se han implementado acciones de mejora?",
                    "Â¿Hay procedimientos para tratar no conformidades?",
                    "Â¿La empresa mejora procesos segÃºn sus falencias?"
                ]
            }
        ];

        // Generar el cuestionario dinÃ¡micamente
        var cuestionario = document.getElementById('cuestionario');
        var contador = 0;

        datosAuditoria.forEach(function (item) {
            if (item.type === "titulo") {
                cuestionario.innerHTML += `<div class="section-title">${item.texto}</div>`;
            } else if (item.type === "grid") {
                cuestionario.innerHTML += `<div style="margin-top:15px; font-weight:bold; color:#ab925c;">${item.titulo}</div>`;
                item.filas.forEach(function (pregunta) {
                    contador++;
                    cuestionario.innerHTML += crearPregunta('q' + contador, pregunta);
                });
            }
        });

        // Manejo del formulario
        document.getElementById('formAuditoria').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const respuestas = {};

            // Recopilar todas las respuestas
            for (let [key, value] of formData.entries()) {
                if (key !== 'fecha') {
                    const pregunta = document.querySelector(`input[name="${key}"]`)
                        .closest('.question-block')
                        .querySelector('.question-text').textContent;
                    respuestas[pregunta] = value;
                }
            }

            const datos = {
                fecha: formData.get('fecha'),
                respuestas: respuestas
            };

            try {
                const response = await fetch('/api/guardar_checklist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const resultado = await response.json();
                const mensaje = document.getElementById('mensaje');

                if (resultado.exito) {
                    mensaje.innerHTML = `âœ… AuditorÃ­a guardada. <button onclick="window.location.href='/auditor/ver_pdf/${resultado.pdf_url.split('/').pop()}'" style="background:linear-gradient(135deg,#ab925c,#c9a961); color:#1a1a1a; border:none; padding:8px 16px; border-radius:5px; cursor:pointer; font-weight:bold;">Ver PDF ğŸ“„</button>`;
                    this.reset();
                    window.scrollTo(0, 0);
                } else {
                    mensaje.innerHTML = `âŒ Error: ${resultado.mensaje}`;
                }
            } catch (error) {
                document.getElementById('mensaje').innerHTML = `âŒ Error de conexiÃ³n: ${error}`;
            }
        });
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => { if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74 || e.keyCode == 67)) || (e.ctrlKey && (e.keyCode == 85 || e.keyCode == 83))) { e.preventDefault(); } });
        document.addEventListener('copy', e => e.preventDefault());
        document.addEventListener('dragstart', e => e.preventDefault());
    </script>
</body>

</html>