<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestionar perfil de Usuario — Royal Crumbs</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <style>
        .account-config {
            margin-top: 30px;
            border-top: 1px solid #444;
            padding-top: 20px;
        }

        .action-buttons {
            margin-top: 30px;
            display: flex;
            gap: 10px;
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }
    </style>
</head>

<body oncontextmenu="return false;" ondragstart="return false;" onselectstart="return false;">
    <div class="rc-container">

        <!-- ===== ENCABEZADO ===== -->
        <header class="rc-header">
            <a href="/admin/usuarios" class="rc-back">‹</a>
            <h1 class="rc-screen-title">Gestionar perfil</h1>
            <div></div>
        </header>

        <div id="loading" style="text-align:center; margin-top:50px;">Cargando...</div>

        <!-- ===== FORMULARIO ===== -->
        <form class="user-form" id="userForm" style="display:none;">
            <label>Email (ID)</label>
            <input type="email" id="email" readonly style="background:#111; color:#888;">

            <label>Rol</label>
            <input type="text" id="rol" readonly style="background:#111; color:#888;">

            <label>Nombre</label>
            <input type="text" id="nombre" readonly>

            <label>Apellido</label>
            <input type="text" id="apellido" readonly>

            <label>Saldo Actual</label>
            <input type="text" id="saldo" readonly style="color:#ab925c; font-weight:bold;">

            <!-- ===== CONFIGURACIÓN DE CUENTA ===== -->
            <section class="account-config">
                <h2 style="color:#fff; margin-bottom:15px;">Estado de Cuenta</h2>
                <div class="status-buttons">
                    <button type="button" class="status-btn" id="btn-activo">Activa</button>
                    <button type="button" class="status-btn" id="btn-inactivo">Inactiva</button>
                </div>
            </section>

            <!-- ===== BOTONES ===== -->
            <div class="action-buttons">
                <button type="button" class="btn-gold" onclick="alert('Funcionalidad de edición en desarrollo')">Guardar
                    Cambios</button>
                <button type="button" class="delete-btn"
                    onclick="alert('Funcionalidad de eliminar en desarrollo')">Eliminar Cuenta</button>
            </div>
        </form>

    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const userId = params.get('id');
        let currentUserActive = true; // Estado actual del usuario

        async function cargarUsuario() {
            if (!userId) {
                alert("ID de usuario no proporcionado");
                window.location.href = "/admin/usuarios";
                return;
            }

            try {
                const res = await fetch(`/api/admin/usuarios/${userId}`);
                const data = await res.json();

                if (data.success) {
                    const user = data.user;
                    document.getElementById('email').value = user.email;
                    document.getElementById('rol').value = user.rol;
                    document.getElementById('nombre').value = user.nombre;
                    document.getElementById('apellido').value = user.apellido;
                    document.getElementById('saldo').value = `$${user.saldo_actual || 0.00}`;

                    // Guardar estado actual
                    currentUserActive = user.activo;
                    actualizarBotonesEstado(user.activo);

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('userForm').style.display = 'block';
                } else {
                    alert("Usuario no encontrado");
                    window.location.href = "/admin/usuarios";
                }
            } catch (e) {
                console.error(e);
                alert("Error cargando usuario");
            }
        }

        // Actualizar apariencia de los botones según el estado
        function actualizarBotonesEstado(activo) {
            const btnActivo = document.getElementById('btn-activo');
            const btnInactivo = document.getElementById('btn-inactivo');

            // Limpiar clases
            btnActivo.classList.remove('active');
            btnInactivo.classList.remove('blocked');

            if (activo) {
                btnActivo.classList.add('active');
            } else {
                btnInactivo.classList.add('blocked');
            }
        }

        // Función para cambiar el estado del usuario
        async function cambiarEstado(nuevoEstado) {
            if (currentUserActive === nuevoEstado) return; // No hay cambio

            const accion = nuevoEstado ? 'activar' : 'desactivar';
            const confirmar = confirm(`¿Está seguro de ${accion} esta cuenta de usuario?`);

            if (!confirmar) return;

            try {
                const res = await fetch(`/api/admin/usuarios/${userId}/estado`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ activo: nuevoEstado })
                });

                const data = await res.json();

                if (data.success) {
                    currentUserActive = nuevoEstado;
                    actualizarBotonesEstado(nuevoEstado);
                    alert(data.mensaje);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo cambiar el estado'));
                }
            } catch (e) {
                console.error(e);
                alert('Error de conexión al cambiar el estado');
            }
        }

        // Event listeners para los botones de estado
        document.getElementById('btn-activo').addEventListener('click', () => cambiarEstado(true));
        document.getElementById('btn-inactivo').addEventListener('click', () => cambiarEstado(false));

        document.addEventListener("DOMContentLoaded", cargarUsuario);
    </script>
    <script src="{{ url_for('static', filename='js/security.js') }}"></script>
</body>

</html>