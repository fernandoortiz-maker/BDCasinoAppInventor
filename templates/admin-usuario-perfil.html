<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar perfil de Usuario — Royal Crumbs</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <style>
        .account-config {
            margin-top: 30px;
            border-top: 1px solid #444;
            padding-top: 20px;
        }

        .action-buttons {
            margin-top: 30px;
            display: flex;
            gap: 10px;
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }

        .delete-btn:hover {
            background: #d32f2f;
        }

        .btn-gold:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .status-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #444;
            background: #1a1a1a;
            color: #888;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .status-btn.active {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .status-btn.blocked {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }
    </style>
</head>

<body>
    <div class="rc-container">

        <!-- ===== ENCABEZADO ===== -->
        <header class="rc-header">
            <a href="/admin/usuarios" class="rc-back">‹</a>
            <h1 class="rc-screen-title">Gestionar perfil</h1>
            <div></div>
        </header>

        <div id="loading" style="text-align:center; margin-top:50px;">Cargando...</div>

        <!-- ===== FORMULARIO ===== -->
        <form class="user-form" id="userForm" style="display:none;" onsubmit="guardarCambios(event)">
            <label>Email (ID)</label>
            <input type="email" id="email" readonly style="background:#111; color:#888;">

            <label>Rol</label>
            <input type="text" id="rol" readonly style="background:#111; color:#888;">

            <label>Nombre</label>
            <input type="text" id="nombre" required>

            <label>Apellido</label>
            <input type="text" id="apellido" required>

            <label>Nueva Contraseña (dejar vacío para no cambiar)</label>
            <input type="password" id="password" placeholder="••••••••">

            <label>Saldo Actual</label>
            <input type="text" id="saldo" readonly style="color:#ab925c; font-weight:bold;">

            <!-- ===== CONFIGURACIÓN DE CUENTA ===== -->
            <section class="account-config">
                <h2 style="color:#fff; margin-bottom:15px;">Estado de Cuenta</h2>
                <div class="status-buttons">
                    <button type="button" class="status-btn" id="btn-activo"
                        onclick="cambiarEstado(true)">Activa</button>
                    <button type="button" class="status-btn" id="btn-inactivo"
                        onclick="cambiarEstado(false)">Inactiva</button>
                </div>
            </section>

            <!-- ===== BOTONES ===== -->
            <div class="action-buttons">
                <button type="submit" class="btn-gold">Guardar Cambios</button>
                <button type="button" class="delete-btn" onclick="eliminarUsuario()">Eliminar Cuenta</button>
            </div>
        </form>

    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const userId = params.get('id');
        let currentUser = null;
        let estadoActual = true;

        async function cargarUsuario() {
            if (!userId) {
                alert("ID de usuario no proporcionado");
                window.location.href = "/admin/usuarios";
                return;
            }

            try {
                const res = await fetch(`/api/admin/usuarios/${userId}`);
                const data = await res.json();

                if (data.success) {
                    currentUser = data.user;
                    document.getElementById('email').value = currentUser.email;
                    document.getElementById('rol').value = currentUser.rol;
                    document.getElementById('nombre').value = currentUser.nombre;
                    document.getElementById('apellido').value = currentUser.apellido;
                    document.getElementById('saldo').value = `$${currentUser.saldo_actual || 0.00}`;

                    estadoActual = currentUser.activo;
                    actualizarBotonesEstado();

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('userForm').style.display = 'block';
                } else {
                    alert("Usuario no encontrado");
                    window.location.href = "/admin/usuarios";
                }
            } catch (e) {
                console.error(e);
                alert("Error cargando usuario");
            }
        }

        function actualizarBotonesEstado() {
            const btnActivo = document.getElementById('btn-activo');
            const btnInactivo = document.getElementById('btn-inactivo');

            btnActivo.classList.remove('active');
            btnInactivo.classList.remove('blocked');

            if (estadoActual) {
                btnActivo.classList.add('active');
            } else {
                btnInactivo.classList.add('blocked');
            }
        }

        async function cambiarEstado(activo) {
            try {
                const res = await fetch(`/api/admin/usuarios/${userId}/estado`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ activo })
                });

                const data = await res.json();

                if (data.success) {
                    estadoActual = activo;
                    actualizarBotonesEstado();
                    alert(`Usuario ${activo ? 'activado' : 'desactivado'} correctamente`);
                } else {
                    alert('Error al cambiar el estado: ' + (data.error || 'Error desconocido'));
                }
            } catch (e) {
                console.error(e);
                alert('Error al cambiar el estado');
            }
        }

        async function guardarCambios(event) {
            event.preventDefault();

            const nombre = document.getElementById('nombre').value;
            const apellido = document.getElementById('apellido').value;
            const password = document.getElementById('password').value;

            const payload = { nombre, apellido };
            if (password && password.length > 0) {
                payload.password = password;
            }

            try {
                const res = await fetch(`/api/admin/usuarios/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.success) {
                    alert('Usuario actualizado correctamente');
                    document.getElementById('password').value = '';
                    cargarUsuario(); // Recargar datos
                } else {
                    alert('Error al actualizar: ' + (data.error || 'Error desconocido'));
                }
            } catch (e) {
                console.error(e);
                alert('Error al guardar cambios');
            }
        }

        async function eliminarUsuario() {
            if (!confirm('¿Estás seguro de eliminar este usuario? Esta acción no se puede deshacer.')) {
                return;
            }

            if (!confirm('CONFIRMACIÓN FINAL: ¿Realmente deseas eliminar este usuario?')) {
                return;
            }

            try {
                const res = await fetch(`/api/admin/usuarios/${userId}`, {
                    method: 'DELETE'
                });

                const data = await res.json();

                if (data.success) {
                    alert('Usuario eliminado correctamente');
                    window.location.href = '/admin/usuarios';
                } else {
                    alert('Error al eliminar: ' + (data.error || 'Error desconocido'));
                }
            } catch (e) {
                console.error(e);
                alert('Error al eliminar usuario');
            }
        }

        document.addEventListener("DOMContentLoaded", cargarUsuario);
    </script>
</body>

</html>