<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tickets ‚Äî Agente Soporte</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/agente-tickets.css') }}">
</head>

<body oncontextmenu="return false;" ondragstart="return false;" onselectstart="return false;">
    <div class="rc-container">

        <!-- ENCABEZADO -->
        <header class="rc-header">
            <a href="/agente" class="rc-back">‚Äπ</a>
            <h1 class="rc-screen-title">Todos los Tickets</h1>
            <div></div>
        </header>

        <!-- FILTROS -->
        <section class="filters-section">
            <div class="filter-group">
                <label>Estado</label>
                <select id="filtro-estado">
                    <option value="">Todos</option>
                    <option value="Abierto">Abierto</option>
                    <option value="En Proceso">En Proceso</option>
                    <option value="Cerrado">Cerrado</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Asignaci√≥n</label>
                <select id="filtro-asignado">
                    <option value="">Todos</option>
                    <option value="si">Asignados</option>
                    <option value="no">Sin asignar</option>
                </select>
            </div>

            <button class="filter-btn" onclick="aplicarFiltros()">Filtrar</button>
        </section>

        <!-- LISTA DE TICKETS -->
        <section class="tickets-list" id="tickets-container">
            <div class="no-tickets">‚è≥ Cargando tickets...</div>
        </section>

    </div>

    <script>
        const idAgente = parseInt(localStorage.getItem('userId'));

        async function cargarTickets(estado = '', asignado = '') {
            const container = document.getElementById('tickets-container');
            container.innerHTML = '<div class="no-tickets">‚è≥ Cargando tickets...</div>';

            try {
                let url = '/api/agente/tickets?';
                if (estado) url += `estado=${estado}&`;
                if (asignado) url += `asignado=${asignado}`;

                const response = await fetch(url);

                if (!response.ok) throw new Error('Error al cargar tickets');

                const data = await response.json();
                mostrarTickets(data.tickets);

            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = '<div class="no-tickets" style="color:#f44336;">‚ùå Error al cargar los tickets</div>';
            }
        }

        function mostrarTickets(tickets) {
            const container = document.getElementById('tickets-container');

            if (!tickets || tickets.length === 0) {
                container.innerHTML = '<div class="no-tickets">üì≠ No hay tickets disponibles</div>';
                return;
            }

            container.innerHTML = tickets.map(ticket => `
        <div class="ticket-card" onclick="verTicket(${ticket.id_ticket})">
          <div class="ticket-header">
            <span class="ticket-id">Ticket #${ticket.id_ticket}</span>
            <span class="ticket-estado estado-${(ticket.estado || '').toLowerCase().replace(' ', '-')}">${ticket.estado}</span>
          </div>
          <div class="ticket-info">
            <h3>${ticket.asunto}</h3>
            <div class="ticket-meta">
              <span>üë§ ${ticket.nombre_usuario || 'Usuario'}</span>
              <span>üìÖ ${ticket.fecha_creacion ? new Date(ticket.fecha_creacion).toLocaleDateString() : 'N/A'}</span>
              ${ticket.nombre_agente ? `<span>üë®‚Äçüíº ${ticket.nombre_agente}</span>` : '<span style="color:#ab925c;">‚ö†Ô∏è Sin asignar</span>'}
            </div>
            <p class="ticket-mensaje">${ticket.mensaje || ''}</p>
          </div>
        </div>
      `).join('');
        }

        function aplicarFiltros() {
            const estado = document.getElementById('filtro-estado').value;
            const asignado = document.getElementById('filtro-asignado').value;
            cargarTickets(estado, asignado);
        }

        function verTicket(idTicket) {
            window.location.href = `/agente/ticket/${idTicket}`;
        }

        // Cargar al inicio
        document.addEventListener('DOMContentLoaded', cargarTickets);

        // Actualizar cada 30 segundos
        setInterval(() => aplicarFiltros(), 30000);
    </script>
    <script src="{{ url_for('static', filename='js/security.js') }}"></script>
</body>

</html>